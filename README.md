# å…¥ç¾¤æéªŒéªŒè¯åç«¯æœåŠ¡ (group-verify-service)
## åŸä½œï¼š[yjwmidc/group-verify-service](https://github.com/yjwmidc/group-verify-service/)

<div align="center">

![UGC Avatar](https://socialify.git.ci/VanillaNahida/group-verify-service/image?description=1&font=KoHo&forks=1&issues=1&language=1&name=1&owner=1&pattern=Circuit%20Board&pulls=1&stargazers=1&theme=Auto)

[![GitHub license](https://img.shields.io/github/license/VanillaNahida/group-verify-service?style=flat-square)](https://github.com/VanillaNahida/group-verify-service/blob/main/LICENSE)
[![GitHub stars](https://img.shields.io/github/stars/VanillaNahida/group-verify-service?style=flat-square)](https://github.com/VanillaNahida/group-verify-service/stargazers)
[![GitHub forks](https://img.shields.io/github/forks/VanillaNahida/group-verify-service?style=flat-square)](https://github.com/VanillaNahida/group-verify-service/network)
[![GitHub issues](https://img.shields.io/github/issues/VanillaNahida/group-verify-service?style=flat-square)](https://github.com/VanillaNahida/group-verify-service/issues)
[![php8](https://img.shields.io/badge/PHP-8.0+-blue.svg?style=flat-square)](https://www.php.net/)
[![Platform](https://img.shields.io/badge/Platform-Windows%20%7C%20Linux-brightgreen.svg?style=flat-square)]()

[ğŸ“¦ ä¸‹è½½ä½¿ç”¨](#-å®‰è£…æ­¥éª¤) | [ğŸ“– APIæ–‡æ¡£](#-api-æ–‡æ¡£) | [ğŸ’¬ é—®é¢˜åé¦ˆ](https://github.com/VanillaNahida/group-verify-service/issues)

</div>

## é¡¹ç›®ç®€ä»‹

ä¸ºé¡¹ç›®[astrbot_plugin_group_geetest_verify](https://github.com/VanillaNahida/astrbot_plugin_group_geetest_verify)ç¾¤èŠå…¥ç¾¤éªŒè¯æ’ä»¶å¼€å‘çš„åç«¯ï¼Œä½¿ç”¨æéªŒGeetest V4å®ç°å…¥ç¾¤äººæœºéªŒè¯å¤„ç†ï¼ŒåŸºäº ThinkPHP 8 æ¡†æ¶å¼€å‘çš„æéªŒéªŒè¯ç æœåŠ¡ï¼Œæä¾›å®Œæ•´çš„äººæœºéªŒè¯è§£å†³æ–¹æ¡ˆï¼Œé€šè¿‡ç”ŸæˆéªŒè¯é“¾æ¥ã€å—è¯•è€…è®¿é—®é“¾æ¥éªŒè¯è·å–éªŒè¯ç ï¼Œå†æŠŠéªŒè¯ç å‘åˆ°ç¾¤èŠï¼Œæœºå™¨äººæ”¶åˆ°éªŒè¯ç åï¼Œè°ƒç”¨åç«¯æ¥å£éªŒè¯éªŒè¯ç æ˜¯å¦æ­£ç¡®ï¼Œè‹¥æ­£ç¡®åˆ™å…è®¸å…¥ç¾¤ï¼Œå¦åˆ™æ‹’ç»å…¥ç¾¤ã€‚

## æ•ˆæœå±•ç¤º

<div align="center">

<img src="img/1.png" alt="æ•ˆæœå›¾1" width="600" />

<br />

<img src="img/2.png" alt="æ•ˆæœå›¾2" width="600" />

<br />

<img src="img/3.png" alt="æ•ˆæœå›¾3" width="600" />

</div>

## æŠ€æœ¯æ ˆ

- PHP 8.0+
- ThinkPHP 8.0
- ThinkORM 3.0/4.0
- SQLite æ•°æ®åº“
- Vue 3
- ArcoDesign Vue
- Vite

## åŠŸèƒ½ç‰¹æ€§

- ç”Ÿæˆå”¯ä¸€éªŒè¯é“¾æ¥
- é›†æˆæéªŒ 4.0 è¡Œä¸ºéªŒè¯
- ç”Ÿæˆ 6 ä½æ•°å­—+å­—æ¯éªŒè¯ç 
- éªŒè¯ç æœ‰æ•ˆæœŸç®¡ç†
- éªŒè¯ç ä½¿ç”¨çŠ¶æ€è·Ÿè¸ª
- éªŒè¯ç ä½¿ç”¨åè‡ªåŠ¨å¤±æ•ˆ
- è¿‡æœŸéªŒè¯ç è‡ªåŠ¨æ¸…ç†
- API å¯†é’¥è®¤è¯ä¿æŠ¤
- RESTful API è®¾è®¡
- ä½¿ç”¨SHA256(ç¾¤èŠID+ç”¨æˆ·ID+æ—¶é—´æˆ³+ç›å€¼)ç®—æ³•ç”ŸæˆTicket
- è¯¦ç»†çš„é”™è¯¯æç¤ºä¿¡æ¯

## å®‰è£…æ­¥éª¤

### å³å¼€å³ç”¨éƒ¨ç½²ï¼ˆæ¨èï¼ŒæœåŠ¡å™¨æ— éœ€å®‰è£…ä¾èµ–ï¼‰

è¯¥æ–¹æ¡ˆçš„ç›®æ ‡æ˜¯ï¼šæœåŠ¡å™¨ç«¯åªåšä¸Šä¼ ä¸é…ç½®è¿è¡Œç›®å½•ï¼Œä¸åœ¨æœåŠ¡å™¨ä¸Šæ‰§è¡Œ composerã€‚

1. å‡†å¤‡å‘å¸ƒåŒ…

- ç›´æ¥ä½¿ç”¨ä»“åº“è‡ªå¸¦çš„ `vendor/`ï¼ˆå·²åŒ…å«ä¾èµ–ï¼‰
- å¦‚æœä½ æ›´æ–°äº†ä¾èµ–ï¼Œéœ€è¦åœ¨æœ¬åœ°/CI é‡æ–°ç”Ÿæˆ `vendor/`ï¼ˆåœ¨ `backend/` ç›®å½•æ‰§è¡Œï¼‰ï¼š

```bash
composer install --no-dev -o
```

æœ¬åœ°/CI çš„ PHP éœ€è¦å¯ç”¨ä»¥ä¸‹æ‰©å±•ï¼ˆå¦åˆ™ä¾èµ–æ— æ³•å®‰è£…æˆ–è¿è¡Œæ—¶æ— æ³•è¿æ¥ SQLiteï¼‰ï¼š

- fileinfo
- sqlite3
- pdo_sqlite

2. ä¸Šä¼ åˆ°æœåŠ¡å™¨

- ä¸Šä¼  `backend/` ç›®å½•ä¸‹çš„æ‰€æœ‰æ–‡ä»¶ï¼ˆåŒ…å« `vendor/`ï¼‰
- ç«™ç‚¹è¿è¡Œç›®å½•/ç½‘ç«™ç›®å½•æŒ‡å‘ `backend/public/`
- ç¡®ä¿ `runtime/`ã€`database/` ç›®å½•å¯å†™

> Nginx ç”¨æˆ·è¯·åŠ¡å¿…é…ç½®ä¼ªé™æ€ï¼ˆå¦åˆ™ ThinkPHP è·¯ç”±å¯èƒ½æ— æ³•ç”Ÿæ•ˆï¼‰ï¼Œå¹¶ç¦æ­¢ç›´æ¥è®¿é—®è¿è¡Œç›®å½•ã€‚ç¤ºä¾‹ï¼ˆæ”¾åœ¨ `server {}` ä¸­ï¼‰ï¼š
>
> ```nginx
> location / {
>     if (!-e $request_filename){
>         rewrite  ^(.*)$  /index.php?s=$1  last;   break;
>     }
> }
> ```

3. é¦–æ¬¡åˆå§‹åŒ–

- è®¿é—® `https://ä½ çš„åŸŸå/setup`
- æŒ‰é¡µé¢æç¤ºå¡«å†™ `GEETEST_CAPTCHA_ID`ã€`GEETEST_CAPTCHA_KEY`ã€`API_KEY`ã€`SALT` ç­‰
- æäº¤åä¼šè‡ªåŠ¨ç”Ÿæˆ `.env` å¹¶åˆå§‹åŒ– SQLite æ•°æ®åº“
- ä»…é¦–æ¬¡å®‰è£…å¯ç”¨ï¼šå½“ `.env` å·²å­˜åœ¨æ—¶ï¼Œ`/setup` ä¼šè¿”å› 404

### å‰ç«¯æ„å»ºäº§ç‰©ï¼ˆæäº¤ä»£ç æ—¶è‡ªåŠ¨åŒæ­¥åˆ°åç«¯ publicï¼‰

å‰ç«¯æºç åœ¨ `frontend/`ï¼Œæ„å»ºäº§ç‰©è¾“å‡ºåˆ° `backend/public/static/verify/`ï¼Œåç«¯é€šè¿‡ `GET /v/:ticket` æä¾›éªŒè¯é¡µé¢å…¥å£ã€‚

å¦‚éœ€â€œæäº¤ä»£ç æ—¶è‡ªåŠ¨æ„å»ºå¹¶æŠŠäº§ç‰©å†™å…¥åç«¯ publicâ€ï¼Œå¯å¯ç”¨ä»“åº“å†…ç½®çš„ git hookï¼š

```bash
git config core.hooksPath githooks
```

å¯ç”¨åï¼Œå½“æœ¬æ¬¡æäº¤æ¶‰åŠå‰ç«¯ç›¸å…³å˜æ›´æ—¶ä¼šè‡ªåŠ¨æ‰§è¡Œï¼š

```bash
cd frontend && npm run build
```

è¯´æ˜ï¼š
- ä»…å½“æœ¬æ¬¡æäº¤çš„æš‚å­˜åŒºåŒ…å« `frontend/` æˆ– `backend/public/static/verify/` çš„å˜æ›´æ—¶æ‰ä¼šæ‰§è¡Œæ„å»º
- è‹¥éœ€è¦æ„å»ºä½†æ„å»ºå¤±è´¥ï¼ˆæˆ–æœªå®‰è£… npmï¼‰ï¼Œä¼šç›´æ¥é˜»æ­¢æäº¤

## é¡¹ç›®ç»“æ„

```
backend/
â”œâ”€â”€ app/
â”‚   â”œâ”€â”€ command/                    # å‘½ä»¤è¡Œå·¥å…·
â”‚   â”‚   â””â”€â”€ InitDatabase.php        # æ•°æ®åº“åˆå§‹åŒ–å‘½ä»¤
â”‚   â”œâ”€â”€ controller/                 # æ§åˆ¶å™¨
â”‚   â”‚   â”œâ”€â”€ Index.php               # é»˜è®¤æ§åˆ¶å™¨
â”‚   â”‚   â””â”€â”€ VerifyController.php    # éªŒè¯ç ç›¸å…³æ¥å£
â”‚   â”œâ”€â”€ middleware/                 # ä¸­é—´ä»¶
â”‚   â”‚   â””â”€â”€ ApiAuth.php            # API å¯†é’¥è®¤è¯ä¸­é—´ä»¶
â”‚   â”œâ”€â”€ model/                     # æ¨¡å‹
â”‚   â”‚   â”œâ”€â”€ GeetestModel.php       # æéªŒéªŒè¯ä¸šåŠ¡é€»è¾‘
â”‚   â”‚   â””â”€â”€ GeetestTable.php       # æ•°æ®åº“æ¨¡å‹
â”‚   â”œâ”€â”€ BaseController.php         # åŸºç¡€æ§åˆ¶å™¨
â”‚   â”œâ”€â”€ AppService.php             # åº”ç”¨æœåŠ¡
â”‚   â”œâ”€â”€ ExceptionHandle.php        # å¼‚å¸¸å¤„ç†
â”‚   â”œâ”€â”€ Request.php                # è¯·æ±‚ç±»
â”‚   â”œâ”€â”€ common.php                 # å…¬å…±å‡½æ•°
â”‚   â”œâ”€â”€ event.php                  # äº‹ä»¶å®šä¹‰
â”‚   â”œâ”€â”€ middleware.php             # ä¸­é—´ä»¶é…ç½®
â”‚   â”œâ”€â”€ provider.php               # æœåŠ¡æä¾›è€…
â”‚   â””â”€â”€ service.php                # æœåŠ¡å®šä¹‰
â”œâ”€â”€ config/                       # é…ç½®æ–‡ä»¶åŠ è½½å™¨
â”‚   â”œâ”€â”€ app.php                   # åº”ç”¨é…ç½®
â”‚   â”œâ”€â”€ database.php              # æ•°æ®åº“é…ç½®
â”‚   â”œâ”€â”€ geetest.php               # æéªŒé…ç½®
â”‚   â”œâ”€â”€ cache.php                 # ç¼“å­˜é…ç½®
â”‚   â”œâ”€â”€ log.php                   # æ—¥å¿—é…ç½®
â”‚   â”œâ”€â”€ middleware.php            # ä¸­é—´ä»¶é…ç½®
â”‚   â”œâ”€â”€ route.php                 # è·¯ç”±é…ç½®
â”‚   â”œâ”€â”€ session.php               # ä¼šè¯é…ç½®
â”‚   â””â”€â”€ ...                       # å…¶ä»–é…ç½®æ–‡ä»¶
â”œâ”€â”€ database/                     # æ•°æ®åº“æ–‡ä»¶
â”‚   â”œâ”€â”€ migrations/
â”‚   â”‚   â””â”€â”€ Geetest_Table.sql     # æ•°æ®åº“è¿ç§»æ–‡ä»¶
â”‚   â””â”€â”€ .gitkeep
â”œâ”€â”€ public/                       # é™æ€èµ„æºå’Œå…¥å£æ–‡ä»¶
â”‚   â”œâ”€â”€ index.php                 # åº”ç”¨å…¥å£
â”‚   â”œâ”€â”€ router.php                # è·¯ç”±æ–‡ä»¶
â”‚   â””â”€â”€ static/                   # é™æ€èµ„æº
â”‚       â””â”€â”€ verify/               # å‰ç«¯æ„å»ºäº§ç‰©ï¼ˆVueï¼‰
â”œâ”€â”€ route/                       # è·¯ç”±é…ç½®
â”‚   â””â”€â”€ app.php                   # è·¯ç”±å®šä¹‰
â”œâ”€â”€ extend/                     # æ‰©å±•ç±»åº“
â”‚   â””â”€â”€ .gitignore
â”œâ”€â”€ runtime/                    # è¿è¡Œæ—¶ç¼“å­˜
â”‚   â””â”€â”€ .gitignore
â”œâ”€â”€ .example.env                # ç¯å¢ƒå˜é‡æ¨¡æ¿
â”œâ”€â”€ .gitignore                  # Git å¿½ç•¥æ–‡ä»¶
â”œâ”€â”€ .htaccess                   # Apache é…ç½®
â”œâ”€â”€ .travis.yml                 # Travis CI é…ç½®
â”œâ”€â”€ composer.json               # Composer é…ç½®
â””â”€â”€ think                       # ThinkPHP å‘½ä»¤è¡Œå·¥å…·

frontend/
â”œâ”€â”€ index.html
â”œâ”€â”€ package.json
â”œâ”€â”€ vite.config.js
â””â”€â”€ src/
    â”œâ”€â”€ main.js
    â””â”€â”€ App.vue
```

## API æ–‡æ¡£

**æ³¨æ„**ï¼šä»¥ä¸‹æ¥å£ä¸­æ ‡æ³¨éœ€è¦ API å¯†é’¥è®¤è¯çš„æ¥å£ï¼Œå¿…é¡»åœ¨è¯·æ±‚å¤´ä¸­æ·»åŠ  `Authorization` å­—æ®µï¼š

```
Authorization: Bearer ä½ çš„APIå¯†é’¥
```

### 1. ç”ŸæˆéªŒè¯é“¾æ¥

**æ¥å£åœ°å€**ï¼š`POST /verify/create`

**è®¤è¯æ–¹å¼**ï¼šéœ€è¦ API å¯†é’¥è®¤è¯

**è¯·æ±‚å‚æ•°**ï¼š

| å‚æ•°å | ç±»å‹ | å¿…å¡« | æè¿° |
|--------|------|------|------|
| group_id | string | æ˜¯ | åˆ†ç»„ IDï¼ˆå¿…é¡»ä¸ºæ•°å­—ï¼‰ |
| user_id | string | æ˜¯ | ç”¨æˆ· IDï¼ˆå¿…é¡»ä¸ºæ•°å­—ï¼‰ |

**è¿”å›ç¤ºä¾‹**ï¼š

```json
{
    "code": 0,
    "msg": "success",
    "data": {
        "ticket": "a5294bcefc82bdc5b7990f577df8430274aefb116df1d6e337156ef9c17d56eb",
        "url": "http://localhost:8000/v/a5294bcefc82bdc5b7990f577df8430274aefb116df1d6e337156ef9c17d56eb",
        "expire": 300
    }
}
```

**é”™è¯¯ç¤ºä¾‹**ï¼š

```json
{
    "code": 400,
    "msg": "å‚æ•°é”™è¯¯ï¼šgroup_id å’Œ user_id å¿…é¡»ä¸ºæ•°å­—"
}
```

### 2. éªŒè¯é¡µé¢

**æ¥å£åœ°å€**ï¼š`GET /v/:ticket`

**è®¤è¯æ–¹å¼**ï¼šæ— éœ€è®¤è¯

**è¯·æ±‚å‚æ•°**ï¼š

| å‚æ•°å | ç±»å‹ | å¿…å¡« | æè¿° |
|--------|------|------|------|
| ticket | string | æ˜¯ | éªŒè¯ä»¤ç‰Œï¼ˆURL è·¯å¾„å‚æ•°ï¼‰ |

**è¿”å›**ï¼šHTMLï¼ˆSPA å…¥å£é¡µé¢ï¼Œå‰ç«¯ä¼šè°ƒç”¨çŠ¶æ€æ¥å£æŸ¥è¯¢ ticket æ˜¯å¦æœ‰æ•ˆï¼‰

**é”™è¯¯å“åº”**ï¼š
- ticket ä¸ºç©ºï¼šè¿”å› 400 çŠ¶æ€ç å’Œ"æ— æ•ˆçš„éªŒè¯é“¾æ¥"

### 2.1 ç¥¨æ®çŠ¶æ€

**æ¥å£åœ°å€**ï¼š`GET /verify/status/:ticket`

**è®¤è¯æ–¹å¼**ï¼šæ— éœ€è®¤è¯

**è¿”å›ç¤ºä¾‹**ï¼ˆæœªéªŒè¯ï¼‰ï¼š

```json
{
  "code": 0,
  "msg": "success",
  "data": {
    "ticket": "xxx",
    "verified": false,
    "captcha_id": "ä½ çš„captcha_id",
    "code_expire": 300,
    "expire_minutes": 5
  }
}
```

**è¿”å›ç¤ºä¾‹**ï¼ˆå·²éªŒè¯ï¼‰ï¼š

```json
{
  "code": 0,
  "msg": "success",
  "data": {
    "ticket": "xxx",
    "verified": true,
    "code": "A3B5C7",
    "code_expire": 300,
    "expire_minutes": 5
  }
}
```

### 3. æéªŒéªŒè¯å›è°ƒ

**æ¥å£åœ°å€**ï¼š`POST /verify/callback`

**è®¤è¯æ–¹å¼**ï¼šæ— éœ€è®¤è¯

**è¯·æ±‚å‚æ•°**ï¼š

| å‚æ•°å | ç±»å‹ | å¿…å¡« | æè¿° |
|--------|------|------|------|
| ticket | string | æ˜¯ | éªŒè¯ä»¤ç‰Œ |
| lot_number | string | æ˜¯ | æéªŒéªŒè¯æ‰¹æ¬¡å· |
| captcha_output | string | æ˜¯ | æéªŒéªŒè¯è¾“å‡º |
| pass_token | string | æ˜¯ | æéªŒéªŒè¯é€šè¡Œè¯ |
| gen_time | string | æ˜¯ | æéªŒéªŒè¯ç”Ÿæˆæ—¶é—´ |

**è¿”å›ç¤ºä¾‹**ï¼š

```json
{
    "code": 0,
    "msg": "éªŒè¯æˆåŠŸ",
    "data": {
        "code": "A3B5C7"
    }
}
```

**é”™è¯¯ç¤ºä¾‹**ï¼š

```json
{
    "code": 400,
    "msg": "éªŒè¯å¤±è´¥ï¼Œè¯·é‡è¯•"
}
```

### 4. éªŒè¯éªŒè¯ç 

**æ¥å£åœ°å€**ï¼š`POST /verify/check`

**è®¤è¯æ–¹å¼**ï¼šéœ€è¦ API å¯†é’¥è®¤è¯

**è¯·æ±‚å‚æ•°**ï¼š

| å‚æ•°å | ç±»å‹ | å¿…å¡« | æè¿° |
|--------|------|------|------|
| group_id | string | æ˜¯ | åˆ†ç»„ IDï¼ˆå¿…é¡»ä¸ºæ•°å­—ï¼‰ |
| user_id | string | å¦ | ç”¨æˆ· IDï¼ˆå¿…é¡»ä¸ºæ•°å­—ï¼‰ |
| code | string | æ˜¯ | éªŒè¯ç ï¼ˆ6 ä½æ•°å­—+å­—æ¯ï¼‰ |

**è¿”å›ç¤ºä¾‹**ï¼š

```json
{
    "code": 0,
    "msg": "éªŒè¯é€šè¿‡",
    "passed": true,
    "data": {
        "user_id": "33550336",
        "group_id": "33550336"
    }
}
```

**é”™è¯¯ç¤ºä¾‹**ï¼š

```json
{
    "code": 400,
    "msg": "éªŒè¯å¤±è´¥ï¼šéªŒè¯ç å·²ä½¿ç”¨",
    "passed": false
}
```

**å¯èƒ½çš„é”™è¯¯ä¿¡æ¯**ï¼š
- å‚æ•°é”™è¯¯ï¼šç¼ºå°‘å¿…å¡«å‚æ•° group_id æˆ– code
- å‚æ•°é”™è¯¯ï¼šgroup_id å¿…é¡»ä¸ºæ•°å­—
- å‚æ•°é”™è¯¯ï¼šuser_id å¿…é¡»ä¸ºæ•°å­—
- éªŒè¯å¤±è´¥ï¼šéªŒè¯ç å·²ä½¿ç”¨
- éªŒè¯å¤±è´¥ï¼šéªŒè¯ç å·²è¿‡æœŸ
- éªŒè¯å¤±è´¥ï¼šéªŒè¯ç æœªå®ŒæˆéªŒè¯
- éªŒè¯å¤±è´¥ï¼šéªŒè¯ç ä¸å­˜åœ¨æˆ–å·²å¤±æ•ˆ
- éªŒè¯å¤±è´¥ï¼šç”¨æˆ·IDä¸åŒ¹é…

### 5. æ¸…ç†è¿‡æœŸéªŒè¯ç 

**æ¥å£åœ°å€**ï¼š`GET /verify/clean`

**è®¤è¯æ–¹å¼**ï¼šéœ€è¦ API å¯†é’¥è®¤è¯

**è¿”å›ç¤ºä¾‹**ï¼š

```json
{
    "code": 0,
    "msg": "æ¸…ç†äº† 5 ä¸ªè¿‡æœŸéªŒè¯ç "
}
```

## ä½¿ç”¨æµç¨‹

1. **ç”ŸæˆéªŒè¯é“¾æ¥**ï¼šBot è°ƒç”¨ `POST /verify/create` æ¥å£ï¼ˆéœ€åœ¨è¯·æ±‚å¤´æ·»åŠ  API å¯†é’¥ï¼‰ï¼Œä¼ å…¥ `group_id` å’Œ `user_id`ï¼Œè·å–éªŒè¯é“¾æ¥å’Œ `ticket`
2. **ç”¨æˆ·éªŒè¯**ï¼šç”¨æˆ·è®¿é—®çŸ­é“¾æ¥ `http://domain/v/{ticket}`ï¼Œå®ŒæˆæéªŒè¡Œä¸ºéªŒè¯
3. **è·å–éªŒè¯ç **ï¼šéªŒè¯é€šè¿‡åï¼Œç³»ç»Ÿç”Ÿæˆ 6 ä½æ•°å­—+å­—æ¯éªŒè¯ç ï¼Œé¡µé¢æ˜¾ç¤ºéªŒè¯ç å¹¶æä¾›ä¸€é”®å¤åˆ¶åŠŸèƒ½
4. **æäº¤éªŒè¯ç **ï¼šç”¨æˆ·åœ¨ç¾¤èŠä¸­å‘é€éªŒè¯ç 
5. **éªŒè¯éªŒè¯ç **ï¼šBot è°ƒç”¨ `POST /verify/check` æ¥å£ï¼ˆéœ€åœ¨è¯·æ±‚å¤´æ·»åŠ  API å¯†é’¥ï¼‰ï¼ŒéªŒè¯éªŒè¯ç çš„æœ‰æ•ˆæ€§
6. **è‡ªåŠ¨å¤±æ•ˆ**ï¼šéªŒè¯ç éªŒè¯é€šè¿‡åè‡ªåŠ¨å¤±æ•ˆï¼Œæ— æ³•é‡å¤ä½¿ç”¨

## å¼€å‘æ–¹å¼

### 1. è¿è¡Œå¼€å‘æœåŠ¡å™¨

```bash
cd backend && php think run
```

### 2. ä»£ç è§„èŒƒ

- éµå¾ª PSR-4 è‡ªåŠ¨åŠ è½½è§„èŒƒ
- éµå¾ª ThinkPHP ä»£ç è§„èŒƒ
- ä½¿ç”¨ PHP 8.0+ ç‰¹æ€§

### 4. æ•°æ®åº“æ“ä½œ

é¡¹ç›®ä½¿ç”¨ ThinkORM è¿›è¡Œæ•°æ®åº“æ“ä½œï¼Œé»˜è®¤ä½¿ç”¨ SQLite æ•°æ®åº“ï¼Œå¯åœ¨ `.env` æ–‡ä»¶ä¸­ä¿®æ”¹ä¸ºå…¶ä»–æ•°æ®åº“ã€‚

#### æ•°æ®åº“è¡¨ç»“æ„

**GeetestTable** - éªŒè¯ç æ•°æ®è¡¨

| å­—æ®µå | ç±»å‹ | è¯´æ˜ |
|--------|------|------|
| id | INTEGER | ä¸»é”®ï¼Œè‡ªå¢ |
| token | VARCHAR(64) | éªŒè¯ä»¤ç‰Œï¼ˆå”¯ä¸€ï¼‰ |
| group_id | VARCHAR(64) | åˆ†ç»„ ID |
| user_id | VARCHAR(64) | ç”¨æˆ· ID |
| code | VARCHAR(10) | 6ä½éªŒè¯ç  |
| verified | TINYINT(1) | æ˜¯å¦å·²å®ŒæˆæéªŒéªŒè¯ï¼ˆ0:æœªéªŒè¯, 1:å·²éªŒè¯ï¼‰ |
| used | TINYINT(1) | éªŒè¯ç æ˜¯å¦å·²ä½¿ç”¨ï¼ˆ0:æœªä½¿ç”¨, 1:å·²ä½¿ç”¨ï¼‰ |
| ip | VARCHAR(45) | ç”¨æˆ· IP åœ°å€ |
| user_agent | VARCHAR(500) | ç”¨æˆ·æµè§ˆå™¨æ ‡è¯† |
| extra | TEXT | é¢å¤–æ•°æ®ï¼ˆJSON æ ¼å¼ï¼‰ |
| expire_at | INTEGER | è¿‡æœŸæ—¶é—´æˆ³ |
| verified_at | INTEGER | éªŒè¯å®Œæˆæ—¶é—´æˆ³ |
| used_at | INTEGER | éªŒè¯ç ä½¿ç”¨æ—¶é—´æˆ³ |
| created_at | INTEGER | åˆ›å»ºæ—¶é—´æˆ³ |
| updated_at | INTEGER | æ›´æ–°æ—¶é—´æˆ³ |

**ç´¢å¼•è¯´æ˜**ï¼š
- `idx_code_group`: code + group_id ç»„åˆç´¢å¼•ï¼Œç”¨äºå¿«é€ŸæŸ¥æ‰¾éªŒè¯ç 
- `idx_group_user`: group_id + user_id ç»„åˆç´¢å¼•ï¼Œç”¨äºå¿«é€ŸæŸ¥æ‰¾ç”¨æˆ·éªŒè¯è®°å½•
- `idx_expire`: expire_at ç´¢å¼•ï¼Œç”¨äºå¿«é€Ÿæ¸…ç†è¿‡æœŸæ•°æ®

### 5. æ·»åŠ æ–°åŠŸèƒ½

- åœ¨ `app/controller/` ç›®å½•ä¸‹æ·»åŠ æ§åˆ¶å™¨
- åœ¨ `route/app.php` æ–‡ä»¶ä¸­æ·»åŠ è·¯ç”±
- åœ¨ `app/model/` ç›®å½•ä¸‹æ·»åŠ æ¨¡å—

## é…ç½®è¯´æ˜

é¦–æ¬¡éƒ¨ç½²æ—¶ï¼Œå¦‚æœè¿˜æ²¡æœ‰ `.env`ï¼Œå¯ä»¥ç›´æ¥è®¿é—® `/setup` èµ°é¡µé¢åˆå§‹åŒ–ç”Ÿæˆ `.env` å¹¶åˆå§‹åŒ– SQLite æ•°æ®åº“ï¼ˆ`.env` å·²å­˜åœ¨æ—¶ `/setup` ä¼šè¿”å› 404ï¼‰ã€‚

### æéªŒé…ç½®

æéªŒé…ç½®é€šè¿‡ `.env` æ–‡ä»¶ä¸­çš„ç¯å¢ƒå˜é‡è¿›è¡Œè®¾ç½®ï¼š

| é…ç½®é¡¹ | ç±»å‹ | é»˜è®¤å€¼ | æè¿° |
|--------|------|--------|------|
| GEETEST_CAPTCHA_ID | string | - | æéªŒéªŒè¯ç  ID |
| GEETEST_CAPTCHA_KEY | string | - | æéªŒéªŒè¯ç  Key |
| GEETEST_API_SERVER | string | https://gcaptcha4.geetest.com | æéªŒ API æœåŠ¡å™¨åœ°å€ |
| GEETEST_CODE_EXPIRE | int | 300 | éªŒè¯ç æœ‰æ•ˆæœŸï¼ˆç§’ï¼‰ |

### API å¯†é’¥é…ç½®

| å˜é‡å | ç±»å‹ | é»˜è®¤å€¼ | æè¿° |
|--------|------|--------|------|
| API_KEY | string | - | API è®¿é—®å¯†é’¥ï¼Œç”¨äºä¿æŠ¤éœ€è¦è®¤è¯çš„æ¥å£ |

### Ticket ç”Ÿæˆç›å€¼é…ç½®

| å˜é‡å | ç±»å‹ | é»˜è®¤å€¼ | æè¿° |
|--------|------|--------|------|
| SALT | string | - | Ticket ç”Ÿæˆç›å€¼ï¼Œç”¨äºç”Ÿæˆ ticket çš„å“ˆå¸Œå€¼ï¼Œå»ºè®®ä½¿ç”¨å¤æ‚å­—ç¬¦ä¸²ï¼Œé•¿åº¦è‡³å°‘ 32 ä½ï¼Œä¸è¦æ³„éœ² |

**é‡è¦è¯´æ˜**ï¼š
- ç›å€¼ç”¨äºç”Ÿæˆ ticket çš„å“ˆå¸Œå€¼ï¼Œç®—æ³•ä¸º `SHA256(ç¾¤èŠID+ç”¨æˆ·ID+æ—¶é—´æˆ³+ç›å€¼)`
- å»ºè®®ä½¿ç”¨éšæœºå­—ç¬¦ä¸²ï¼Œè¶Šå¤æ‚è¶Šå¥½
- è¯·å¦¥å–„ä¿ç®¡ç›å€¼ï¼Œé¿å…æ³„éœ²ç»™æœªæˆæƒçš„ç¬¬ä¸‰æ–¹
- ä¸€æ—¦ç›å€¼æ³„éœ²ï¼Œæ”»å‡»è€…å¯èƒ½ä¼ªé€ æœ‰æ•ˆçš„éªŒè¯é“¾æ¥

### æ•°æ®åº“é…ç½®

| å˜é‡å | ç±»å‹ | é»˜è®¤å€¼ | æè¿° |
|--------|------|--------|------|
| DB_DRIVER | string | sqlite | æ•°æ®åº“é©±åŠ¨ç±»å‹ï¼ˆsqlite/mysql/pgsqlï¼‰ |
| DB_HOST | string | 127.0.0.1 | æ•°æ®åº“ä¸»æœºåœ°å€ |
| DB_NAME | string | - | æ•°æ®åº“åç§° |
| DB_USER | string | root | æ•°æ®åº“ç”¨æˆ·å |
| DB_PASS | string | - | æ•°æ®åº“å¯†ç  |
| DB_PORT | int | 3306 | æ•°æ®åº“ç«¯å£ |
| DB_CHARSET | string | utf8mb4 | æ•°æ®åº“å­—ç¬¦é›† |
| DB_PREFIX | string | - | æ•°æ®åº“è¡¨å‰ç¼€ |
| DB_SQLITE_PATH | string | ./database/geetest.db | SQLite æ•°æ®åº“æ–‡ä»¶è·¯å¾„ |

### åº”ç”¨é…ç½®

| å˜é‡å | ç±»å‹ | é»˜è®¤å€¼ | æè¿° |
|--------|------|--------|------|
| APP_DEBUG | bool | true | æ˜¯å¦å¼€å¯è°ƒè¯•æ¨¡å¼ |
| APP_NAMESPACE | string | - | åº”ç”¨å‘½åç©ºé—´ |
| WITH_ROUTE | bool | true | æ˜¯å¦å¯ç”¨è·¯ç”± |
| DEFAULT_APP | string | index | é»˜è®¤åº”ç”¨ |
| DEFAULT_TIMEZONE | string | Asia/Shanghai | é»˜è®¤æ—¶åŒº |
| ERROR_MESSAGE | string | é¡µé¢é”™è¯¯ï¼è¯·ç¨åå†è¯•ï½ | é”™è¯¯æç¤ºä¿¡æ¯ |
| SHOW_ERROR_MSG | bool | false | æ˜¯å¦æ˜¾ç¤ºè¯¦ç»†é”™è¯¯ä¿¡æ¯ |

## æ³¨æ„äº‹é¡¹

1. **è¯·å¦¥å–„ä¿ç®¡å¥½æ‚¨çš„æéªŒéªŒè¯ç  ID å’Œ Keyã€API å¯†é’¥å’Œ Ticket ç”Ÿæˆç›å€¼ï¼ˆSALTï¼‰ï¼Œé¿å…æ³„éœ²ç»™æœªæˆæƒçš„ç¬¬ä¸‰æ–¹**
2. å»ºè®®åœ¨ç”Ÿäº§ç¯å¢ƒä¸­å…³é—­è°ƒè¯•æ¨¡å¼ï¼ˆ`APP_DEBUG = false`ï¼‰
3. è™½ç„¶é¡¹ç›®ä¼šå®šæœŸæ¸…ç†è¿‡æœŸçš„éªŒè¯ç ï¼Œä½†ä½ ä¹Ÿå¯é€šè¿‡å®šæ—¶ä»»åŠ¡è°ƒç”¨ `GET /verify/clean` æ¥å£æ¥æ‰‹åŠ¨æ¸…ç†ã€‚
4. éªŒè¯ç æœ‰æ•ˆæœŸé»˜è®¤ 5 åˆ†é’Ÿï¼ˆ300 ç§’ï¼‰ï¼Œå¯æ ¹æ®å®é™…éœ€æ±‚è°ƒæ•´ `GEETEST_CODE_EXPIRE`
5. å»ºè®®ä½¿ç”¨ HTTPS åè®®éƒ¨ç½²æœåŠ¡
6. éªŒè¯ç ä¸º 6 ä½æ•°å­—+å­—æ¯ç»„åˆï¼ŒéªŒè¯é€šè¿‡åéªŒè¯ç å’ŒéªŒè¯é“¾æ¥ä¼šè‡ªåŠ¨å¤±æ•ˆï¼Œæ— æ³•é‡å¤ä½¿ç”¨
7. `group_id` å’Œ `user_id` å‚æ•°å¿…é¡»ä¸ºæ•°å­—ç±»å‹ï¼Œå¦åˆ™ä¼šè¿”å›å‚æ•°é”™è¯¯
8. éªŒè¯é¡µé¢ä½¿ç”¨çŸ­é“¾æ¥æ ¼å¼ `http://ä½ çš„åŸŸå/v/{ticket}`ï¼Œä¾¿äºåˆ†äº«

## è®¸å¯è¯

Apache-2.0 license

## è´¡çŒ®

æ¬¢è¿æäº¤ Issue å’Œ Pull Requestï¼
